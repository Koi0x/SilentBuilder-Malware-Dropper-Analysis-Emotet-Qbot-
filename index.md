
Analysis of SilentBuilder Dropper document used to deploy Emotet / Qbot. 

### ***Overview***

`Hash: 5bdb533c81de6ca17a3a532eb92c6771703529ae3016f43b6d3aa787f300b4e3`

`Sample: https://bazaar.abuse.ch/sample/5bdb533c81de6ca17a3a532eb92c6771703529ae3016f43b6d3aa787f300b4e3/`

### General Information

When the document is opened, the user is presented with.

![image](https://user-images.githubusercontent.com/95584654/159196796-ec1c10a8-f946-46e1-ad1d-1a92d7117b4a.png)

When trying to view the macros embedded into the script, none are visible.

![image](https://user-images.githubusercontent.com/95584654/159196817-389ad8cc-2206-47f6-8ae7-c2c8b52f34af.png)

### Information Enumeration Using Oletools

Using oletools, we can take a deeper look into the document itself. We are using olebrowse and looking at the Hex-View under the DocumentSummaryInformation tab. Take note at the first highlighted box, you can see a reference to Sheet 1, but other sheets appear to be present. Also, take note that the document is using Excel 4.0 macros. 

![image](https://user-images.githubusercontent.com/95584654/159196832-cc65d5b0-02b5-4570-b555-3d08fa7dc2f0.png)

Using olevba, we can also confirm this theory as it detects hidden sheets in the document that have embedded macros in them. 

```
VBA MACRO xlm_macro.txt
in file: xlm_macro - OLE stream: 'xlm_macro'
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
' 0085     13 BOUNDSHEET : Sheet Information - worksheet or dialog sheet, hidden -  Grrr
' 0085     13 BOUNDSHEET : Sheet Information - worksheet or dialog sheet, visible -  Shee
' 0085     13 BOUNDSHEET : Sheet Information - worksheet or dialog sheet, hidden -  Sbrr
' 0085     15 BOUNDSHEET : Sheet Information - Excel 4.0 macro sheet, hidden -  EFWFSF
' 0085     11 BOUNDSHEET : Sheet Information - Excel 4.0 macro sheet, hidden -  Br
' 0085     11 BOUNDSHEET : Sheet Information - Excel 4.0 macro sheet, hidden -  Br
```

Looking further into the output provided by olevba, you will see that the flag AutoExec is set so that it will run the macros when the document is opened. 

### Analyzing Excel Document 

Using LibreOffice Calc, open the document and then go to `Sheet -> Show Sheet` and then select all of the sheets and make them visible.  

Firstly, looking at the page Grrr1, there are a bunch of random characters. Looking further into the document, this sheet acts are the "Dictionary" for the dropper in which the other sheets will call to get values. 

NOTE: When analyzing this document, everything is is split up into different cells as a means to obfuscate what's going on.

![image](https://user-images.githubusercontent.com/95584654/159196866-0df7cf4a-8e03-42ff-b0ee-3163e423fd5c.png)

Looking through the remaining sheets, on Sbrr1 we can see the domains to which the macros are reaching out to download following stage loaders. 

![image](https://user-images.githubusercontent.com/95584654/159196880-f1eb7432-8634-481a-a730-ebe676456a31.png)

IOC's:

- http[s]://duvarkagitlarimodelleri.com/42hhp/gZXakh7/
- http[s]://dolphinwavehavuzrobotu.com/wp-includes/RmCbvIKjjtlB3tabyPo/
- htt[p]://animalsandusfujairah.com/wp-admin/JWO58zeUOwSI/
- http[s]://havuzkaydiraklari.com/wp-includes/YqYdLFA/
- htt[p]://vipwatchpay.com/Isoetales/5wy8L0TQ1xCZEr/

Moving on. Looking at the same sheet, we can see a reference to `"urlmon","URLDownloadTo`. We can obviously make the assumption that this is going to call the URLDownloadToFile function from the Windows API to download the next stages of the infection. As mentioned above, Grrr1 acts as the "Dictionary" from which all of the other sheets call from. Reference the screenshot below. 

![image](https://user-images.githubusercontent.com/95584654/159196897-dd45ee96-d94d-425f-ac28-6abefcbc98ae.png)

We can also see that they are looking to download .ocx file from the domains. For example, `\xxw1.ocx`. Note that these are actually DLL files. 

Looking at the same sheet, we can also see references to regsvr32.exe in which will be used to register and run the .ocx files (DLL Files) that are being downloaded. They will use some common functions like ShellExecuteExA and or ShellExecuteExW to run regsvr32.exe with the needed parameters.

Let's now take a look at the sheet EFWFSFG. While the actual formation of the macro was corrupted in this sample (Reference screenshot below), understanding how Excel 4.0 Macros work makes the following assumption very plausible. Similar to how other cells were created by calling the Cell IDs, this part works the same way. Excel 4.0 macros allow you to use =CALL to run a macro. So at the final stages of the dropper, it will formulate the macros using the needed info such as the function calls, domains, filenames etc... and then use =CALL to execute the macro. 

![image](https://user-images.githubusercontent.com/95584654/159196908-b09f7240-9f90-4011-b6e8-520a2de2ed48.png)
